<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wishlist</title>
    <th:block th:replace="~{layout::link-css}"></th:block>
    <th:block th:replace="~{layout::custom-css}"></th:block>
  </head>
  <body>
    <th:block th:replace="~{layout::header}"></th:block>
    <div class="container container-page">
      <div class="card p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="m-0">Wishlist</h2>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-danger btn-sm" id="clearBtn">Clear</button>
            <a class="btn btn-primary btn-sm" href="/books">Add more</a>
          </div>
        </div>
        <div class="mt-3 d-flex search-bar">
          <input class="form-control" id="kw" placeholder="Tìm theo tiêu đề, tác giả, danh mục">
          <button class="btn btn-outline-secondary" id="resetBtn">Reset</button>
        </div>
      </div>
      <div class="card">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Id</th>
              <th>Title</th>
              <th>Author</th>
              <th>Price</th>
              <th>Category</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="wishBody"></tbody>
        </table>
      </div>
    </div>
    <th:block th:replace="~{layout::footer}"></th:block>
    <script>
      (function(){
        const body = document.getElementById('wishBody');
        const kw = document.getElementById('kw');
        function render(){
          const list = JSON.parse(localStorage.getItem('wishlist') || '[]');
          const q = String(kw.value || '').toLowerCase().trim();
          const filtered = q ? list.filter(b => {
            return String(b.title||'').toLowerCase().includes(q)
              || String(b.author||'').toLowerCase().includes(q)
              || String(b.category||'').toLowerCase().includes(q);
          }) : list;
          body.innerHTML = filtered.map(b => `
            <tr>
              <td>${b.id}</td>
              <td><a href="/books/detail/${b.id}">${b.title}</a></td>
              <td>${b.author}</td>
              <td>${b.price ?? ''}</td>
              <td>${b.category ?? ''}</td>
              <td>
                <form th:action="@{/books/add-to-cart}" method="post" class="d-inline">
                  <input type="hidden" name="id" value="${b.id}">
                  <input type="hidden" name="name" value="${b.title}">
                  <input type="hidden" name="price" value="${b.price ?? ''}">
                  <button type="submit" class="btn btn-primary btn-sm" onclick="return confirm('Thêm vào giỏ hàng?')">Add to cart</button>
                </form>
                <button class="btn btn-outline-danger btn-sm ms-1" data-id="${b.id}" onclick="removeWish(this)">Remove</button>
              </td>
            </tr>
          `).join('');
        }
        render();
        kw.addEventListener('input', render);
        document.getElementById('resetBtn').addEventListener('click', ()=>{
          kw.value = '';
          render();
        });
        document.getElementById('clearBtn').addEventListener('click', ()=>{
          localStorage.removeItem('wishlist');
          render();
        });
        window.removeWish = function(btn){
          const id = btn.getAttribute('data-id');
          let list = JSON.parse(localStorage.getItem('wishlist') || '[]');
          list = list.filter(b => String(b.id) !== String(id));
          localStorage.setItem('wishlist', JSON.stringify(list));
          render();
        }
      })();
    </script>
  </body>
  </html>
