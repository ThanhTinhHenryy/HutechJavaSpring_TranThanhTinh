<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Book List</title>
    <th:block th:replace="~{layout::link-css}"></th:block>
    <th:block th:replace="~{layout::custom-css}"></th:block>
  </head>
  <body>
    <th:block th:replace="~{layout::header}"></th:block>
    <div class="container container-page">
      <div class="row">
        <div class="col-md-12">
          <div class="card p-3 mb-3">
            <div class="container-fluid">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="m-0">API Book List</h2>
              </div>
              <form class="d-flex search-bar" id="search-form">
                <input class="form-control me-2" type="search" placeholder="Keyword" aria-label="Search" name="keyword" id="keyword" />
                <select class="form-control me-2" id="category">
                  <option value="">All categories</option>
                </select>
                <input class="form-control me-2" type="number" step="0.01" min="0" placeholder="Min price" id="minPrice" />
                <input class="form-control me-2" type="number" step="0.01" min="0" placeholder="Max price" id="maxPrice" />
                <button class="btn btn-primary" type="submit">Apply</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div class="mb-3">
        <div class="btn-group" role="group" aria-label="Sort">
          <button class="btn btn-outline-primary" data-sort="id">Sort by Id</button>
          <button class="btn btn-outline-primary" data-sort="title">Sort by Title</button>
          <button class="btn btn-outline-primary" data-sort="author">Sort by Author</button>
          <button class="btn btn-outline-primary" data-sort="price">Sort by Price</button>
          <button class="btn btn-outline-primary" data-sort="category">Sort by Category</button>
        </div>
      </div>
      <div class="card">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Id</th>
            <th>Image</th>
            <th>Title</th>
            <th>Author</th>
            <th>Price</th>
            <th>Category</th>
          </tr>
        </thead>
        <tbody id="books-body"></tbody>
      </table>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <button id="prev" class="btn btn-outline-primary">Prev</button>
          <button id="next" class="btn btn-outline-primary">Next</button>
        </div>
        <div>Page: <span id="page-label">0</span></div>
      </div>
    </div>
    <th:block th:replace="~{layout::footer}"></th:block>
    <script>
      (function () {
        const apiBase = '/api/v1';
        const tbody = document.getElementById('books-body');
        const pageLabel = document.getElementById('page-label');
        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');
        const sortButtons = document.querySelectorAll('[data-sort]');
        const searchForm = document.getElementById('search-form');
        const keywordInput = document.getElementById('keyword');
        const categorySel = document.getElementById('category');
        const minPriceInput = document.getElementById('minPrice');
        const maxPriceInput = document.getElementById('maxPrice');

        let state = {
          pageNo: 0,
          pageSize: 20,
          sortBy: 'id',
          keyword: '',
          categoryId: '',
          minPrice: '',
          maxPrice: ''
        };

        function renderRows(books) {
          tbody.innerHTML = books
            .map(
              (b) => `
              <tr>
                <td>${b.id}</td>
                <td>
                  ${b.imageUrl ? `<img src="${b.imageUrl}" alt="Cover" style="width:40px;height:40px;border-radius:6px;object-fit:cover;">` : `<div style="width:40px;height:40px;border-radius:6px;background:#f0f2f5;display:flex;align-items:center;justify-content:center;font-weight:600;color:#666;">${String(b.title||'').substring(0,1)}</div>`}
                </td>
                <td>${b.title}</td>
                <td>${b.author}</td>
                <td>${b.price ?? ''}</td>
                <td>${b.category ?? ''}</td>
              </tr>`
            )
            .join('');
          pageLabel.textContent = String(state.pageNo);
        }

        async function loadBooks() {
          const url = `${apiBase}/books?pageNo=${state.pageNo}&pageSize=${state.pageSize}&sortBy=${encodeURIComponent(state.sortBy)}`;
          const res = await fetch(url, { credentials: 'same-origin' });
          if (!res.ok) {
            console.error('Failed to load books', res.status);
            return;
          }
          const data = await res.json();
          renderRows(data);
        }

        async function searchBooks() {
          const params = new URLSearchParams({
            pageNo: String(state.pageNo),
            pageSize: String(state.pageSize),
            sortBy: state.sortBy,
          });
          if (state.keyword) params.set('keyword', state.keyword);
          if (state.categoryId) params.set('categoryId', state.categoryId);
          if (state.minPrice) params.set('minPrice', state.minPrice);
          if (state.maxPrice) params.set('maxPrice', state.maxPrice);
          const url = `${apiBase}/books/filter?${params.toString()}`;
          const res = await fetch(url, { credentials: 'same-origin' });
          if (!res.ok) {
            console.error('Failed to search books', res.status);
            return;
          }
          const data = await res.json();
          renderRows(data);
        }

        prevBtn.addEventListener('click', () => {
          state.pageNo = Math.max(0, state.pageNo - 1);
          state.keyword ? searchBooks() : loadBooks();
        });
        nextBtn.addEventListener('click', () => {
          state.pageNo += 1;
          // API không trả totalPages, ta vẫn cho next để xem trang tiếp
          state.keyword ? searchBooks() : loadBooks();
        });
        sortButtons.forEach((btn) =>
          btn.addEventListener('click', () => {
            state.sortBy = btn.dataset.sort;
            state.pageNo = 0;
            state.keyword = '';
            keywordInput.value = '';
            loadBooks();
          })
        );
        searchForm.addEventListener('submit', (e) => {
          e.preventDefault();
          state.keyword = keywordInput.value.trim();
          state.categoryId = categorySel.value || '';
          state.minPrice = minPriceInput.value || '';
          state.maxPrice = maxPriceInput.value || '';
          state.pageNo = 0;
          searchBooks();
        });

        async function loadCategories(){
          try{
            const res = await fetch(`${apiBase}/categories`, { credentials: 'same-origin' });
            if(!res.ok) return;
            const data = await res.json();
            categorySel.innerHTML = '<option value="">All categories</option>' + data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
          }catch(e){}
        }

        loadCategories();
        loadBooks();
      })();
    </script>
  </body>
  </html>
