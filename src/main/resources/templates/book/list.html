<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
  lang="en"
>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>My Book List</title>
    <th:block th:replace="~{layout::link-css}"></th:block>
    <th:block th:replace="~{layout::custom-css}"></th:block>
  </head>
  <body>
    <th:block th:replace="~{layout::header}"></th:block>
    <div class="container container-page">
      <div class="row">
        <div class="col-md-12">
          <div class="card p-3 mb-3">
            <div class="container-fluid">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="m-0">Books</h2>
                <span class="badge badge-soft" th:text="${books.size()}"></span>
              </div>
              <form class="d-flex search-bar" th:action="@{/books/search}" method="get">
                <input
                  class="form-control me-2"
                  type="search"
                  placeholder="Search by title, author, category"
                  aria-label="Search"
                  name="keyword"
                />
                <button class="btn btn-primary" type="submit">
                  Search
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>
              <a
                th:href="@{/books(pageNo=${currentPage}, sortBy='id')}"
                >Id</a
              >
            </th>
            <th>Image</th>
            <th>
              <a
                th:href="@{/books(pageNo=${currentPage}, sortBy='title')}"
                >Title</a
              >
            </th>
            <th>
              <a
                th:href="@{/books(pageNo=${currentPage}, sortBy='author')}"
                >Author</a
              >
            </th>
            <th>
              <a
                th:href="@{/books(pageNo=${currentPage}, sortBy='price')}"
                >Price</a
              >
            </th>
            <th>
              <a
                th:href="@{/books(pageNo=${currentPage}, sortBy='category')}"
                >Category</a
              >
            </th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="book : ${books}">
            <td th:text="${book.getId()}"></td>
            <td>
              <div th:if="${book.imageUrl}">
                <img th:src="@{${book.imageUrl}}" alt="Cover" style="width:48px; height:48px; object-fit:cover; border-radius:6px;">
              </div>
              <div th:unless="${book.imageUrl}" style="width:48px; height:48px; border-radius:6px; background:#f0f2f5; display:flex; align-items:center; justify-content:center; font-weight:600; color:#666;">
                <span th:text="${#strings.substring(book.title,0,1)}"></span>
              </div>
            </td>
            <td><a th:href="@{/books/detail/{id}(id=${book.getId()})}" th:text="${book.getTitle()}"></a></td>
            <td th:text="${book.getAuthor()}"></td>
            <td th:text="${book.getPrice()}"></td>
            <td th:text="${book.getCategory().getName()}"></td>
            <td colspan="2">
              <div class="list-actions">
              <a
                class="btn btn-outline-primary"
                sec:authorize="hasAnyAuthority('ROLE_ADMIN','ADMIN')"
                th:href="@{/books/edit/{id}(id=${book.getId()})}"
                >Edit</a
              >
              <a
                class="btn btn-outline-danger"
                sec:authorize="hasAnyAuthority('ROLE_ADMIN','ADMIN')"
                th:href="@{/books/delete/{id}(id=${book.getId()})}"
                onclick="return confirm('Are you sure you want to delete this book?')"
                >Delete</a
              >
              <form
                th:action="@{/books/add-to-cart}"
                method="post"
                class="d-inline"
              >
                <input type="hidden" name="id" th:value="${book.getId()}" />
                <input
                  type="hidden"
                  name="name"
                  th:value="${book.getTitle()}"
                />
                <input
                  type="hidden"
                  name="price"
                  th:value="${book.getPrice()}"
                />
                <button
                  type="submit"
                  class="btn btn-primary"
                  onclick="return confirm('Are you sure you want to add this book to cart?')"
                >
                  Add to cart
                </button>
              </form>
              <button
                type="button"
                class="btn btn-outline-secondary"
                th:attr="data-id=${book.getId()},data-title=${book.getTitle()},data-author=${book.getAuthor()},data-price=${book.getPrice()},data-category=${book.getCategory().getName()}"
                onclick="addWishlist(this)"
              >
                Add to wishlist
              </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      </div>
      <div class="d-flex justify-content-end my-2">
        <a class="btn btn-outline-secondary btn-sm" href="/api/v1/books/export/csv">Export CSV</a>
        <a class="btn btn-outline-primary btn-sm ms-2" sec:authorize="hasAnyAuthority('ROLE_ADMIN','ADMIN')" href="/books/import">Import CSV</a>
      </div>
    </div>
    <nav aria-label="Page navigation example">
      <ul
        class="pagination justify-content-center pagination-sm"
        th:each="i : ${#numbers.sequence(0, totalPages)}"
      >
        <li
          class="page-item"
          th:classappend="${currentPage == i} ?'active'"
        >
          <a
            class="page-link"
            th:href="@{/books(pageNo=${i})}"
            th:text="${i}"
          ></a>
        </li>
      </ul>
    </nav>
    <th:block th:replace="~{layout::footer}"></th:block>
    <script>
      function addWishlist(btn){
        const item = {
          id: btn.getAttribute('data-id'),
          title: btn.getAttribute('data-title'),
          author: btn.getAttribute('data-author'),
          price: btn.getAttribute('data-price'),
          category: btn.getAttribute('data-category')
        };
        const list = JSON.parse(localStorage.getItem('wishlist') || '[]');
        if(!list.find(b => String(b.id) === String(item.id))){
          list.push(item);
          localStorage.setItem('wishlist', JSON.stringify(list));
          alert('Đã thêm vào wishlist');
        } else {
          alert('Sách đã có trong wishlist');
        }
      }
    </script>
  </body>
</html>
